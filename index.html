<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NADI SENI JPNT - Portal Data</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <style>
        :root { --primary: #0f766e; --accent: #2dd4bf; --bg: #f1f5f9; --white: #ffffff; --dark: #1e293b; }
        * { box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; margin: 0; padding: 0; background-color: var(--bg); color: var(--dark); }
        
        /* HEADER & NAV */
        header { background: var(--white); padding: 15px 30px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 20px rgba(0,0,0,0.03); position: sticky; top: 0; z-index: 1000; }
        .logo-area h1 { margin: 0; font-size: 20px; font-weight: 800; color: var(--primary); }
        .logo-area span { color: var(--accent); }
        .nav-btn { background: transparent; border: none; font-weight: 600; color: #64748b; cursor: pointer; padding: 8px 15px; transition: 0.3s; }
        .nav-btn:hover { color: var(--primary); }
        .btn-login { background: #fee2e2; color: #ef4444; border: 1px solid #fecaca; padding: 8px 15px; border-radius: 8px; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 5px; font-size: 12px; }
        .btn-login.logged-in { background: #dcfce7; color: #166534; border-color: #bbf7d0; }

        /* CONTAINER */
        .container { max-width: 1200px; margin: 30px auto; padding: 0 20px; min-height: 80vh; }
        .hidden { display: none !important; }

        /* DASHBOARD CARDS */
        .grid-menu { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-top: 20px; }
        .menu-card { background: var(--white); border-radius: 12px; padding: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; transition: 0.3s; border: 1px solid #e2e8f0; position: relative; overflow: hidden; }
        .menu-card:hover { transform: translateY(-5px); border-color: var(--accent); }
        .tag { font-size: 10px; font-weight: 800; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; }
        
        /* ADMIN UI - TABS */
        .admin-header { background: white; padding: 20px; border-radius: 16px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }
        .cat-tabs { display: flex; gap: 10px; margin-top: 20px; overflow-x: auto; padding-bottom: 5px; }
        .tab-btn { padding: 10px 20px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 50px; cursor: pointer; font-weight: 600; font-size: 12px; color: #64748b; white-space: nowrap; transition:0.3s; }
        .tab-btn:hover { background: #e2e8f0; }
        .tab-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* ADMIN - SUB ITEMS */
        .sub-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .sub-card { background: white; border: 1px solid #cbd5e1; padding: 15px; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; text-align: center; color: #475569; transition: 0.2s; }
        .sub-card:hover { border-color: var(--primary); color: var(--primary); background: #f0fdfa; }
        .sub-card.selected { background: var(--primary); color: white; border-color: var(--primary); }

        /* DATA TABLE */
        .table-container { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .search-bar { width: 100%; padding: 15px; border: none; border-bottom: 1px solid #e2e8f0; outline: none; font-family: 'Poppins'; font-size: 14px; background: #fff; }
        .data-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .data-table th { background: #f8fafc; text-align: left; padding: 15px; color: #64748b; font-weight: 700; border-bottom: 2px solid #e2e8f0; }
        .data-table td { padding: 12px 15px; border-bottom: 1px solid #f1f5f9; color: #334155; vertical-align: middle; }
        .data-table tr:hover { background: #f0fdfa; }
        .btn-view { background: #3b82f6; color: white; padding: 6px 12px; border-radius: 6px; font-size: 11px; text-decoration: none; display: inline-block; cursor: pointer; }

        /* MODAL DETAIL */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-card { background: white; width: 90%; max-width: 600px; border-radius: 16px; overflow: hidden; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); animation: slideUp 0.3s ease; }
        .modal-head { background: var(--primary); color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 20px; max-height: 70vh; overflow-y: auto; }
        .detail-row { margin-bottom: 15px; border-bottom: 1px solid #f1f5f9; padding-bottom: 10px; }
        .label { font-size: 10px; color: #94a3b8; font-weight: 700; text-transform: uppercase; display: block; margin-bottom: 5px; }
        .value { font-size: 14px; font-weight: 500; color: #334155; word-break: break-word; }
        .action-btns { display: flex; gap: 10px; margin-top: 10px; }
        .btn-action { flex: 1; padding: 10px; border-radius: 8px; text-align: center; text-decoration: none; font-size: 12px; font-weight: 700; color: white; }
        .btn-wa { background: #25D366; } .btn-call { background: #3b82f6; }

        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @media (max-width: 700px) { .header { flex-direction: column; } .sub-grid { grid-template-columns: 1fr 1fr; } }
    </style>
</head>
<body>

    <header>
        <div class="logo-area" onclick="location.reload()">
            <h1>NADI SENI <span>JPNT</span></h1>
        </div>
        <nav>
            <button class="btn-login" id="btn_auth" onclick="handleAuth()">üîí ADMIN LOGIN</button>
        </nav>
    </header>

    <div class="container">

        <div id="view_login" class="hidden" style="text-align:center; padding:50px;">
            <div style="background:white; max-width:400px; margin:0 auto; padding:40px; border-radius:20px; box-shadow:0 10px 30px rgba(0,0,0,0.05);">
                <h3>PENGURUSAN DATA</h3>
                <p style="color:#64748b; font-size:13px; margin-bottom:20px;">Sila log masuk untuk mengakses data peserta.</p>
                <button onclick="loginGoogle()" style="background:#4285F4; color:white; border:none; padding:12px 25px; border-radius:50px; font-weight:600; cursor:pointer;">üîë Log Masuk Google</button>
            </div>
        </div>

        <div id="view_admin" class="hidden">
            <div class="admin-header">
                <h2 id="welcome_msg" style="margin:0;">Dashboard Admin</h2>
                <p style="margin:5px 0 0; font-size:12px; color:#64748b;">Pilih kategori utama di bawah untuk mula menyemak.</p>
                
                <div class="cat-tabs" id="category_tabs">
                    </div>
            </div>

            <div id="sub_category_area" class="sub-grid"></div>

            <div id="loading_msg" class="hidden" style="text-align:center; padding:30px; color:#64748b;">
                Sedang memuat turun data dari pelayan...
            </div>

            <div id="table_area" class="table-container hidden">
                <input type="text" id="tableSearch" class="search-bar" placeholder="üîé Cari Nama Sekolah, Daerah, atau Guru..." onkeyup="filterTable()">
                <div style="overflow-x:auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th width="5%">#</th>
                                <th width="45%">SEKOLAH</th>
                                <th width="30%">DAERAH</th>
                                <th width="20%">TINDAKAN</th>
                            </tr>
                        </thead>
                        <tbody id="data_tbody"></tbody>
                    </table>
                </div>
                <div style="padding:15px; text-align:right; background:#f8fafc; font-size:11px; color:#64748b;">
                    * Data "Hulu Terengganu" mungkin dipaparkan sebagai "Terengganu" jika input asal salah.
                </div>
            </div>
        </div>

        <div id="detail_modal" class="modal-overlay" onclick="closeModal(event)">
            <div class="modal-card">
                <div class="modal-head">
                    <h3 style="margin:0; font-size:16px;">BUTIRAN PENYERTAAN</h3>
                    <button onclick="document.getElementById('detail_modal').style.display='none'" style="background:none; border:none; color:white; font-size:20px; cursor:pointer;">‚úï</button>
                </div>
                <div class="modal-body" id="modal_content">
                    </div>
            </div>
        </div>

    </div>

<script>
    // =================================================================
    // üî• CONFIG FIREBASE
    // =================================================================
    const firebaseConfig = {
        apiKey: "AIzaSyBXqVEgI1EMzXnmKl4uOaf-npykNn4TDeg",
        authDomain: "nadisenijpnt.firebaseapp.com",
        projectId: "nadisenijpnt",
        storageBucket: "nadisenijpnt.firebasestorage.app",
        messagingSenderId: "140808067955",
        appId: "1:140808067955:web:75a432f442ed2240dfc306",
        measurementId: "G-S0FSJYL6E4"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const provider = new firebase.auth.GoogleAuthProvider();

    const ALLOWED_ADMINS = ["naimullahkhalid@gmail.com", "unit.kesenian@gmail.com"];

    // =================================================================
    // üõ†Ô∏è DATABASE LENGKAP
    // =================================================================
    const DATABASE = [
        { cat: "MUZIK", title: "SEIMFONI TRADISIONAL (SM)", csv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQyAZroqQF_DS0MNPr0mSpj-_WibQczhGRuZnfYw908vzQiCDVf7rJGR5pM-KPsxSlPNxDtkkUlLXW1/pub?gid=530649611&single=true&output=csv" },
        { cat: "MUZIK", title: "SAYEMBARA PUISI LAGU (SM)", csv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSxcSxaEsKmEGRyusZJNeFsuCUgo-Po2WM_aygnoXhYlMovue_BgLeeDj3zyDKy0pL-pmTepPHx3lWD/pub?gid=820254919&single=true&output=csv" },
        { cat: "MUZIK", title: "KOIR (SR)", csv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQklqA7GgfvayKWyQrFKAFVFEDN6rjM3IEGC_j13zXgCpNpFJ7q7PfHyVjZvZS2B8kTHmB1R3xf_m-i/pub?gid=765816044&single=true&output=csv" },
        { cat: "MUZIK", title: "ENSEMBLE REKORDER (SR)", csv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSZBPu4r6GvWAlnfVh-kYgIRVS1jmCqZfI3GFsu11bo7XwK5Gcrlisr-U4w17BttJkEE6Q62nWzg2os/pub?gid=231724444&single=true&output=csv" },
        { cat: "MUZIK", title: "ENSEMBLE KIBOD (SR)", csv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSwqbUzkDlJ5LlkBwg2pAFXB8nn8Jke6jAVCdsh0XAlOPcePq2h-WjIEtXXIdWdmXLSwJAzdycg68f1/pub?gid=637401373&single=true&output=csv" },
        { cat: "MUZIK", title: "KOIR (SM)", csv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRAjTsBwlwOxsqKtv7pM3U8J8EbgWsQn4FDZWPsBn31hpQEkgr2Tlr_HpKJAr2-c9uqzlI8-iZ-I9an/pub?gid=12154908&single=true&output=csv" },
        { cat: "MUZIK", title: "NYANYIAN SOLO (SR)", csv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSnDWEQ5YYQ6i6NcGZ4UT0qFZp_tnlJTbct1PrY8ZiL0FE4FDj047LqOTwGI1S2JZs_4NIVbFzpg01E/pub?gid=253030693&single=true&output=csv" },
        { cat: "MUZIK", title: "KOIR (SR) - GENTA", csv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRaQnxV25OoIhBHNIE2M5dGIcmXrv44CdFkv2-iQfk6Y4JD_w4BaDOdFzoCVrlbJhLzhzIbPvrj6Br5/pub?gid=2007862906&single=true&output=csv" },
        { cat: "MUZIK", title: "NYANYIAN SOLO (SM)", csv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQx58IPEc-vv0ufBwnMl4IE4w33Yu4PmpMoJOnqMUaohuSIElmIQUfUA58Xas9FyBcyelHpFernoq1R/pub?gid=314140766&single=true&output=csv" },
        { cat: "MUZIK", title: "KOIR (SM) - GENTA", csv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQEAZa7PCURxgzyIu6mFoMiwwa1u5Fw6T2Yc3DJNh9JcAYuVJz5XzSLJthwYuXsEJ1Q36abbmh-EIbx/pub?gid=428299184&single=true&output=csv" },
        
        { cat: "TARI", title: "TARIAN RAMPAIAN (SR)", csv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRpc33eO29gAnBJOvTqYtZhW1gm6S-i_ZqBzjp0BlI5YjVYwKVRINKJxEWRJlxmo8bp1I7SUma6sJLl/pub?gid=1766610679&single=true&output=csv" },
        { cat: "TARI", title: "TARIAN ETNIK SOLO (SR)", csv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSLg2uRtxafPykBsFBVDhdu_XyyaNM7Kdo9sQNEm8Q0c0V4sX_graaFapN7f47ZmMpYSjOs0Z6fUIqk/pub?gid=887063016&single=true&output=csv" },
        { cat: "TARI", title: "TARI PENCAK (SM)", csv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTHuyPPCz5-1sAfAgXzBj0UepPoH2f85mbsclMEy21CWxt81YaVLEXbe7o0OeAAj2Jf5a20T-cJoLy3/pub?gid=1325506741&single=true&output=csv" },
        { cat: "TARI", title: "TARIAN RAMPAIAN DUO (SM)", csv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTCGkqfK8ng4WVbO0d59q9jrsOFVwV1mj4_xmfmhwEP4IUEFpXyq-K-FEsozBAIOS92bNm9vUfOYrfe/pub?gid=836915996&single=true&output=csv" },

        { cat: "TEATER", title: "SAYEMBARA TEATER (SR)", csv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQuhTAeh-DnF1d4C_FD2qXsCThstByc5BDIiY3Mu_9DaQ4TOyR7ZI820j_hYC2biZ75guEpBPlbi9QB/pub?gid=403963652&single=true&output=csv" },
        { cat: "TEATER", title: "FILEM PENDEK (SR)", csv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQCaPEcywaG0hmSlbxNlDR7wYCMmDDz38EkcY_z8FVCm7hrOkxl1UIBpOpC72yehRmO-7h6CbjN9i7h/pub?gid=515405520&single=true&output=csv" },
        { cat: "TEATER", title: "MONOLOG (SR)", csv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRrWjg5JKEG3u7wuGlurzplsO4cUyKSSnd1r-vBbTNIVpjw4h8GTm3fe3V5ft_XxDubJX3xBlxULzpP/pub?gid=533035291&single=true&output=csv" },
        { cat: "TEATER", title: "SAYEMBARA TEATER (SM)", csv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRwu4OATLjdedRtOHcr7SWW9x6iXDWUlnNxGzf99mdWFhjEbQ4zUkm3olKgxz6q3HpWTtW7ToqW6ePq/pub?gid=2131384172&single=true&output=csv" },
        { cat: "TEATER", title: "FILEM PENDEK (SM)", csv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ0K7LWQs8NUvtYWiiaGDDGlezchrLD1hrRrdDyYQ7EJ_xwbh0_CWtOmr89POiCcOUyIodB4mnLGtl9/pub?gid=209262848&single=true&output=csv" },
        { cat: "TEATER", title: "MONOLOG (SM)", csv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ26wvUkYm-XH_q4vNlpSu14-z_5ZsAhRCJak_Qm86z0IODZ2rvOJAo6rl5JAkPabjHkHIMBALXxUl3/pub?gid=1395475141&single=true&output=csv" },

        { cat: "SENI VISUAL", title: "SENI CETAKAN (SR)", csv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ1pzcqC945Gk88ZfoO2GYDTy5Dxog8LYJEO_pwR22TwXuV6SPg0T1NZ9rXhvkx2W8yB-LjiEpXdTOE/pub?gid=1553102662&single=true&output=csv" },
        { cat: "SENI VISUAL", title: "BUSANA (SM)", csv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRuHv2axq369VII3Ac-KluGMNpMbn6OjvITnEbRhW2_K58hIZ4WgD0tqKrtdITCv-o987xoeK3hptLO/pub?gid=1117005446&single=true&output=csv" },
        { cat: "SENI VISUAL", title: "IFAC JAPAN (MENENGAH)", csv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRI4EW00Y7EWoT7kL2tOmohMG-1UbRapHvMJUOaPFsUetifwSbvq4Myt6bRR15FdZYsaA0fJrwLApNH/pub?gid=474159054&single=true&output=csv" },
        { cat: "SENI VISUAL", title: "KRAF KOLAJ (SR) - NESTLE", csv: "" },
        { cat: "SENI VISUAL", title: "ARCA (SM) - NESTLE", csv: "" }
    ];

    // =================================================================
    // ‚öôÔ∏è AUTHENTICATION
    // =================================================================
    function handleAuth() {
        if(document.getElementById('btn_auth').innerText.includes('LOGOUT')) {
            auth.signOut().then(() => location.reload());
        } else {
            loginGoogle();
        }
    }

    function loginGoogle() { auth.signInWithPopup(provider).catch(e => alert(e.message)); }

    auth.onAuthStateChanged(user => {
        if (user) {
            if (ALLOWED_ADMINS.includes(user.email)) {
                showAdminPanel(user);
            } else {
                alert("Akses Ditolak. Email anda tiada dalam senarai admin.");
                auth.signOut();
            }
        } else {
            document.getElementById('view_login').classList.remove('hidden');
            document.getElementById('view_admin').classList.add('hidden');
        }
    });

    function showAdminPanel(user) {
        document.getElementById('view_login').classList.add('hidden');
        document.getElementById('view_admin').classList.remove('hidden');
        document.getElementById('btn_auth').innerHTML = `üîì ${user.email.split('@')[0]} (LOGOUT)`;
        document.getElementById('btn_auth').classList.add('logged-in');
        renderCategoryTabs();
    }

    // =================================================================
    // üñ•Ô∏è ADMIN UI LOGIC
    // =================================================================
    const CATEGORIES = ["MUZIK", "TARI", "TEATER", "SENI VISUAL"];
    let currentData = []; // Store fetched data for filtering

    function renderCategoryTabs() {
        const container = document.getElementById('category_tabs');
        container.innerHTML = "";
        CATEGORIES.forEach((cat, index) => {
            let btn = document.createElement('button');
            btn.className = `tab-btn ${index === 0 ? 'active' : ''}`;
            btn.innerText = cat;
            btn.onclick = () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                renderSubCategories(cat);
            };
            container.appendChild(btn);
        });
        renderSubCategories(CATEGORIES[0]); // Load first cat
    }

    function renderSubCategories(cat) {
        const container = document.getElementById('sub_category_area');
        container.innerHTML = "";
        document.getElementById('table_area').classList.add('hidden');
        
        const filtered = DATABASE.filter(d => d.cat === cat);
        filtered.forEach(item => {
            let btn = document.createElement('div');
            btn.className = 'sub-card';
            btn.innerText = item.title;
            btn.onclick = () => {
                document.querySelectorAll('.sub-card').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                loadTableData(item);
            };
            container.appendChild(btn);
        });
    }

    // =================================================================
    // üìä DATA PROCESSING & PARSING
    // =================================================================
    function loadTableData(item) {
        if(!item.csv) { alert("Data belum tersedia."); return; }
        
        document.getElementById('loading_msg').classList.remove('hidden');
        document.getElementById('table_area').classList.add('hidden');
        document.getElementById('data_tbody').innerHTML = "";

        fetch(item.csv).then(r => r.text()).then(txt => {
            const rows = txt.trim().split('\n');
            const headers = parseCSVRow(rows[0]); // Get header names
            currentData = []; // Reset global data

            // Find column indexes dynamically
            // (Assuming standard KPM naming, otherwise detecting by keywords)
            let idxSchool = -1, idxDistrict = -1;
            
            headers.forEach((h, i) => {
                const header = h.toUpperCase();
                if(header.includes("SEKOLAH") || header.includes("NAMA SEKOLAH")) idxSchool = i;
                if(header.includes("DAERAH") || header.includes("PPD")) idxDistrict = i;
            });

            // Fallback if header detection fails (Usually Col 2 is School, Col 1 is District)
            if(idxSchool === -1) idxSchool = 2;
            if(idxDistrict === -1) idxDistrict = 1;

            for(let i=1; i<rows.length; i++) {
                if(!rows[i].trim()) continue;
                let cols = parseCSVRow(rows[i]);
                
                // Construct Row Object
                let rowData = {
                    fullRow: cols, // Keep all data for modal
                    headers: headers,
                    school: cols[idxSchool] ? cols[idxSchool].replace(/"/g,'').trim() : "-",
                    district: cols[idxDistrict] ? cols[idxDistrict].replace(/"/g,'').trim() : "-"
                };
                currentData.push(rowData);
            }

            renderTable(currentData);
            document.getElementById('loading_msg').classList.add('hidden');
            document.getElementById('table_area').classList.remove('hidden');
        });
    }

    // üî• POWERFUL CSV PARSER (Fixes comma in quotes)
    function parseCSVRow(text) {
        let ret = [''], i = 0, p = '', s = true;
        for (let l in text) {
            l = text[l];
            let a = ret[i];
            if (p === '"' && l === '"' && a.length > 0) a.slice(0, -1); 
            if (l === '"') s = !s;
            else if (l === ',' && s) l = ret[++i] = '';
            else ret[i] += l;
            p = l;
        }
        return ret;
    }

    function renderTable(data) {
        const tbody = document.getElementById('data_tbody');
        tbody.innerHTML = "";
        
        data.forEach((row, index) => {
            let tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${index+1}</td>
                <td style="font-weight:600; color:var(--primary); text-transform:uppercase;">${row.school}</td>
                <td><span style="background:#f1f5f9; padding:3px 8px; border-radius:4px; font-size:11px;">${row.district}</span></td>
                <td><button class="btn-view" onclick='openDetail(${JSON.stringify(index)})'>üëÅÔ∏è LIHAT</button></td>
            `;
            tbody.appendChild(tr);
        });
    }

    function filterTable() {
        let term = document.getElementById('tableSearch').value.toUpperCase();
        let filtered = currentData.filter(d => 
            d.school.toUpperCase().includes(term) || 
            d.district.toUpperCase().includes(term)
        );
        renderTable(filtered);
    }

    // =================================================================
    // üì± DETAIL MODAL
    // =================================================================
    function openDetail(index) {
        const data = currentData[index];
        const container = document.getElementById('modal_content');
        container.innerHTML = "";

        let phone = "";
        
        // Loop through all columns to show details
        data.headers.forEach((h, i) => {
            let val = data.fullRow[i] ? data.fullRow[i].replace(/"/g,'') : "-";
            
            // Skip Timestamp (Index 0)
            if(i === 0) return;

            // Detect Phone for Buttons
            if(h.toUpperCase().includes("TELEFON") || h.toUpperCase().includes("HP")) {
                phone = val.replace(/[^0-9]/g, ''); // Clean number
                if(!phone.startsWith('6')) phone = '6' + phone; // Add country code if missing
            }

            // Detect Links
            if(val.startsWith("http")) {
                val = `<a href="${val}" target="_blank" style="color:blue; text-decoration:underline;">Buka Pautan</a>`;
            }

            let rowHtml = `
                <div class="detail-row">
                    <span class="label">${h}</span>
                    <span class="value">${val}</span>
                </div>
            `;
            container.innerHTML += rowHtml;
        });

        // Add Action Buttons
        if(phone) {
            let btns = `
                <div class="action-btns">
                    <a href="https://wa.me/${phone}" target="_blank" class="btn-action btn-wa">üí¨ WHATSAPP</a>
                    <a href="tel:${phone}" class="btn-action btn-call">üìû CALL</a>
                </div>
            `;
            container.innerHTML += btns;
        }

        document.getElementById('detail_modal').style.display = 'flex';
    }

    function closeModal(e) {
        if(e.target.id === 'detail_modal') document.getElementById('detail_modal').style.display = 'none';
    }

</script>
</body>
</html>
