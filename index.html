<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Pendaftaran Kesenian JPNT</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <style>
        /* --- 1. DESIGN SYSTEM --- */
        :root { 
            --primary: #0f766e; 
            --dark-green-header: #14532d;
            --bg: #f3f4f6; 
            --white: #ffffff; 
            --dark: #1f2937;
            /* Warna Kad Statistik */
            --stat-green: #10b981;
            --stat-red: #dc2626;
            --stat-blue: #4f46e5;
            --stat-orange: #d97706;
        }

        * { box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; margin: 0; padding: 0; background-color: var(--bg); color: var(--dark); }
        
        /* HEADER NAV */
        header { background: var(--white); padding: 15px 30px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 1000; border-bottom: 1px solid #e5e7eb; }
        .logo-area { cursor: pointer; }
        /* UPDATED TITLE STYLE */
        .logo-area h1 { margin: 0; font-size: 20px; font-weight: 800; color: var(--dark); }
        .logo-area h1 span { color: var(--primary); }
        
        .nav-group { display: flex; gap: 10px; }
        .nav-btn { background: transparent; border: none; font-weight: 600; color: #64748b; cursor: pointer; padding: 8px 15px; border-radius: 50px; transition: 0.3s; font-size: 13px; }
        .nav-btn:hover { background: #f1f5f9; color: var(--primary); }
        .btn-login { background: #fee2e2; color: #ef4444; border: 1px solid #fecaca; }
        .btn-login.logged-in { background: #dcfce7; color: #166534; border-color: #bbf7d0; }

        .container { max-width: 1200px; margin: 20px auto; padding: 0 20px; min-height: 80vh; }
        .hidden { display: none !important; }

        /* --- 2. DASHBOARD STYLE --- */
        .dashboard-header-card { background-color: var(--dark-green-header); color: white; padding: 30px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .dash-title h2 { margin: 0; font-size: 24px; font-weight: 700; }
        .dash-title p { margin: 5px 0 0; opacity: 0.9; font-size: 14px; }
        .dash-actions button { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px; margin-left: 8px; transition: 0.2s; display: inline-flex; align-items: center; gap: 5px; }
        .dash-actions button:hover { background: rgba(255,255,255,0.3); }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .stat-card { padding: 25px; border-radius: 12px; color: white; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); display: flex; flex-direction: column; justify-content: space-between; min-height: 140px; }
        .stat-card h3 { margin: 0; font-size: 13px; font-weight: 500; opacity: 0.9; }
        .stat-card .value { font-size: 36px; font-weight: 800; margin-top: 10px; line-height: 1; }
        
        .bg-green { background-color: var(--stat-green); } .bg-red { background-color: var(--stat-red); }
        .bg-blue { background-color: var(--stat-blue); } .bg-orange { background-color: var(--stat-orange); }

        .filter-area { margin-bottom: 20px; display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; }
        .filter-chip { background: white; border: 1px solid #e5e7eb; padding: 6px 15px; border-radius: 20px; font-size: 12px; font-weight: 600; color: #4b5563; cursor: pointer; white-space: nowrap; transition: 0.2s; }
        .filter-chip.active { background: var(--dark-green-header); color: white; border-color: var(--dark-green-header); }

        .cards-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .detail-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #f3f4f6; cursor: pointer; transition: transform 0.2s; }
        .detail-card:hover { transform: translateY(-3px); border-color: var(--primary); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .card-title { font-weight: 700; font-size: 13px; color: #374151; text-transform: uppercase; }
        .card-badge { background: #dcfce7; color: #166534; font-size: 10px; padding: 2px 8px; border-radius: 4px; font-weight: 700; }

        .progress-row { margin-bottom: 12px; }
        .p-label { display: flex; justify-content: space-between; font-size: 11px; color: #6b7280; margin-bottom: 4px; font-weight: 500; }
        .p-track { height: 6px; background: #e5e7eb; border-radius: 10px; overflow: hidden; }
        .p-fill { height: 100%; border-radius: 10px; background-color: #10b981; }

        /* --- 3. PAGE VIEW --- */
        .registration-card { background: white; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); overflow: hidden; border: 1px solid #e2e8f0; max-width: 800px; margin: 0 auto; text-align: center; }
        .reg-header { background: var(--primary); padding: 40px 20px; color: white; }
        .reg-body { padding: 40px 20px; }
        .btn-primary-lg { display: inline-block; background: var(--primary); color: white; padding: 15px 40px; border-radius: 12px; font-weight: 700; text-decoration: none; font-size: 14px; margin: 10px; width: 100%; max-width: 300px; }
        .btn-secondary-lg { display: inline-block; background: #e2e8f0; color: #334155; padding: 15px 40px; border-radius: 12px; font-weight: 700; text-decoration: none; font-size: 14px; margin: 10px; width: 100%; max-width: 300px; }

        /* --- 4. ADMIN & TABLE --- */
        .admin-header { background: white; padding: 25px; border-radius: 16px; margin-bottom: 20px; }
        .sub-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .sub-card { background: white; border: 1px solid #cbd5e1; padding: 15px; border-radius: 8px; font-size: 11px; font-weight: 600; cursor: pointer; text-align: center; color: #475569; transition: 0.2s; }
        .sub-card:hover { border-color: var(--primary); color: var(--primary); background: #f0fdfa; }
        .sub-card.selected { background: var(--primary); color: white; border-color: var(--primary); }
        .table-container { background: white; border-radius: 12px; overflow: hidden; border: 1px solid #e2e8f0; }
        .data-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .data-table th { background: #f8fafc; text-align: left; padding: 15px; color: #64748b; font-weight: 700; border-bottom: 2px solid #e2e8f0; }
        .data-table td { padding: 12px 15px; border-bottom: 1px solid #f1f5f9; color: #334155; vertical-align: top; }
        .btn-print { background: #10b981; color: white; padding: 10px 20px; border:none; border-radius: 8px; font-weight: 700; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 5px; }

        /* --- 5. MODAL --- */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-card { background: white; width: 95%; max-width: 700px; border-radius: 16px; overflow: hidden; animation: slideUp 0.3s ease; max-height: 90vh; display: flex; flex-direction: column; }
        .modal-head { background: var(--primary); color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .modal-body { padding: 25px; overflow-y: auto; }
        .detail-row { margin-bottom: 15px; border-bottom: 1px solid #f1f5f9; padding-bottom: 10px; }
        .label { font-size: 10px; color: #94a3b8; font-weight: 700; text-transform: uppercase; display: block; margin-bottom: 5px; }
        .value { font-size: 14px; font-weight: 500; color: #334155; }
        .action-btns { display: flex; gap: 10px; margin-top: 20px; }
        .btn-action { flex: 1; padding: 12px; border-radius: 8px; text-align: center; text-decoration: none; font-size: 13px; font-weight: 700; color: white; }
        .btn-wa { background: #25D366; } .btn-call { background: #3b82f6; }
        .btn-view { background: #3b82f6; color: white; padding: 6px 12px; border-radius: 6px; font-size: 11px; border:none; cursor: pointer; }

        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @media (max-width: 768px) { .stats-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <header>
        <div class="logo-area" onclick="bukaHome()"><h1>Dashboard Pendaftaran Kesenian <span>JPNT</span></h1></div>
        <div class="nav-group">
            <button class="nav-btn" onclick="bukaHome()">UTAMA</button>
            <button class="nav-btn btn-login" id="btn_auth" onclick="bukaAdmin()">üîí ADMIN</button>
        </div>
    </header>

    <div class="container">

        <div id="view_dashboard">
            <div class="dashboard-header-card">
                <div class="dash-title">
                    <h2>Analisis Penyertaan</h2>
                    <p>Rekod penyertaan & statistik pertandingan</p>
                </div>
                <div class="dash-actions">
                    <button onclick="location.reload()">üîÑ Reload</button>
                    <button onclick="window.print()">üñ® Cetak</button>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card bg-green"><h3>Jumlah Penyertaan</h3><div class="value" id="grand_total">0</div></div>
                <div class="stat-card bg-red"><h3>Jumlah Acara</h3><div class="value" id="total_events">0</div></div>
                <div class="stat-card bg-blue"><h3>Peratus Data</h3><div class="value">100%</div></div>
                <div class="stat-card bg-orange"><h3>Jumlah Rekod</h3><div class="value" id="total_records_display">0</div></div>
            </div>

            <div style="margin-bottom: 10px; font-weight: 700; color: #4b5563;">KATEGORI:</div>
            <div class="filter-area" id="public_tabs"></div>
            <div id="grid_container" class="cards-grid"></div>
        </div>

        <div id="view_page" class="hidden">
            <button class="nav-btn" onclick="bukaHome()" style="margin-bottom:20px;">‚Üê KEMBALI KE DASHBOARD</button>
            <div class="registration-card">
                <div class="reg-header">
                    <h2 id="page_title" style="margin:0; font-size:24px;">TAJUK</h2>
                    <p style="margin:10px 0 0; opacity:0.9;">Unit Pembangunan Bakat Murid (Kesenian)</p>
                </div>
                <div class="reg-body">
                    <div style="margin-bottom: 30px;">
                        <div id="page_stat" style="font-size:50px; font-weight:800; color:var(--primary); line-height:1;">0</div>
                        <div style="font-size:12px; font-weight:600; color:#64748b; margin-bottom:10px;">PENYERTAAN DITERIMA</div>
                        <button onclick="bukaModalStatistik()" style="background:#f1f5f9; border:none; padding:8px 15px; border-radius:20px; font-size:11px; font-weight:700; color:#0f766e; cursor:pointer;">üìä LIHAT ANALISIS DAERAH</button>
                    </div>
                    <hr style="border:0; border-top:1px solid #f1f5f9; margin: 30px 0;">
                    <div style="display:flex; flex-wrap:wrap; justify-content:center;">
                        <a id="link_form" href="#" target="_blank" class="btn-primary-lg">üìù DAFTAR SEKARANG</a>
                        <a id="link_drive" href="#" target="_blank" class="btn-secondary-lg">üìÇ FOLDER DRIVE</a>
                    </div>
                </div>
            </div>
        </div>

        <div id="view_admin" class="hidden">
            <div id="admin_login_ui" style="text-align:center; padding:50px;">
                <div style="background:white; max-width:400px; margin:0 auto; padding:40px; border-radius:20px; box-shadow:0 10px 30px rgba(0,0,0,0.05);">
                    <h3>PENGURUSAN DATA</h3>
                    <button onclick="loginGoogle()" style="background:#4285F4; color:white; border:none; padding:12px 25px; border-radius:50px; font-weight:600; cursor:pointer; margin-top:20px;">üîë Log Masuk Google</button>
                </div>
            </div>
            <div id="admin_dashboard_ui" class="hidden">
                <div class="admin-header">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div><h2 style="margin:0;">Dashboard Admin</h2><p id="user_display" style="margin:5px 0 0; font-size:12px; color:var(--primary);">...</p></div>
                        <button onclick="logoutGoogle()" style="background:#fee2e2; border:none; color:#ef4444; padding:8px 15px; border-radius:8px; cursor:pointer; font-weight:700; font-size:11px;">LOG KELUAR</button>
                    </div>
                    <div class="filter-area" id="category_tabs" style="margin-top:20px;"></div>
                </div>
                <div id="sub_category_area" class="sub-grid"></div>
                <div id="loading_msg" class="hidden" style="text-align:center; padding:30px; color:#64748b;">Sedang memuat turun data...</div>
                <div id="table_area" class="table-container hidden">
                    <div style="padding:15px; border-bottom:1px solid #e2e8f0; display:flex; gap:10px;">
                        <input type="text" id="tableSearch" style="flex-grow:1; padding:10px; border:1px solid #e2e8f0; border-radius:8px; outline:none;" placeholder="üîé Cari Sekolah, Guru..." onkeyup="filterTable()">
                        <button onclick="printAdminData()" class="btn-print">üñ®Ô∏è CETAK SENARAI</button>
                    </div>
                    <div style="overflow-x:auto;">
                        <table class="data-table"><thead><tr><th width="5%">#</th><th>SEKOLAH</th><th width="20%">DAERAH</th><th width="15%">TINDAKAN</th></tr></thead><tbody id="data_tbody"></tbody></table>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div id="public_stats_modal" class="modal-overlay">
        <div class="modal-card">
            <div class="modal-head"><h3 style="margin:0;">ANALISIS PENYERTAAN MENGIKUT DAERAH</h3><button onclick="document.getElementById('public_stats_modal').style.display='none'" style="background:none; border:none; color:white; font-size:20px;">‚úï</button></div>
            <div class="modal-body">
                <div style="height:350px;"><canvas id="chart_daerah"></canvas></div>
                <div style="margin-top:20px; max-height:250px; overflow-y:auto; border:1px solid #e2e8f0; border-radius:8px;">
                    <table class="data-table"><thead><tr><th style="position:sticky; top:0;">#</th><th style="position:sticky; top:0;">SEKOLAH</th><th style="position:sticky; top:0;">DAERAH</th></tr></thead><tbody id="public_list_body"></tbody></table>
                </div>
            </div>
        </div>
    </div>

    <div id="detail_modal" class="modal-overlay" onclick="if(event.target.id==='detail_modal')this.style.display='none'">
        <div class="modal-card">
            <div class="modal-head"><h3 style="margin:0;">BUTIRAN PESERTA</h3><button onclick="document.getElementById('detail_modal').style.display='none'" style="background:none; border:none; color:white; font-size:20px;">‚úï</button></div>
            <div class="modal-body" id="modal_content"></div>
        </div>
    </div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyBXqVEgI1EMzXnmKl4uOaf-npykNn4TDeg", authDomain: "nadisenijpnt.firebaseapp.com", projectId: "nadisenijpnt", storageBucket: "nadisenijpnt.firebasestorage.app", messagingSenderId: "140808067955", appId: "1:140808067955:web:75a432f442ed2240dfc306", measurementId: "G-S0FSJYL6E4" };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const provider = new firebase.auth.GoogleAuthProvider();
    const ALLOWED_ADMINS = ["naimullahkhalid@gmail.com", "unit.kesenian@gmail.com"];
    
    // Register Chart DataLabels Plugin
    Chart.register(ChartDataLabels);

    const DATABASE = [
        // MUZIK
        { cat: "MUZIK", sub: "FASUS", title: "SEIMFONI TRADISIONAL (SM)", form: "https://forms.gle/KQixYdJZHPoyt1nn9", drive: "https://drive.google.com/drive/folders/1t2oUE62Cn2qm0uVWfziWBObyCA5lcYhQ", csv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQyAZroqQF_DS0MNPr0mSpj-_WibQczhGRuZnfYw908vzQiCDVf7rJGR5pM-KPsxSlPNxDtkkUlLXW1/pub?gid=530649611&single=true&output=csv" },
        { cat: "MUZIK", sub: "FASUS", title: "SAYEMBARA PUISI LAGU (SM)", form: "https://forms.gle/mMQvnVpka1kRiJpVA", drive: "https://drive.google.com/drive/folders/18kIJxHsK8E4KZndbMUAqsFqfnlTHHnnH", csv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSxcSxaEsKmEGRyusZJNeFsuCUgo-Po2WM_aygnoXhYlMovue_BgLeeDj3zyDKy0pL-pmTepPHx3lWD/pub?gid=820254919&single=true&output=csv" },
        { cat: "MUZIK", sub: "FERAS", title: "KOIR (SR)", form: "https://forms.gle/wRGC6VbVacj9jcwd8", drive: "https://drive.google.com/drive/folders/1D_M1Mqa4NCAqi9LsSRRJzHFTkmDMrK2Z", csv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQklqA7GgfvayKWyQrFKAFVFEDN6rjM3IEGC_j13zXgCpNpFJ7q7PfHyVjZvZS2B8kTHmB1R3xf_m-i/pub?gid=765816044&single=true&output=csv" },
        { cat: "MUZIK", sub: "FERAS", title: "ENSEMBLE REKORDER (SR)", form: "https://forms.gle/5dYkpn2361emQUKY8", drive: "https://drive.google.com/drive/folders/1TaEAGtfCv1ptLXjRcw2o6qfBD7pDY4Aj", csv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSZBPu4r6GvWAlnfVh-kYgIRVS1jmCqZfI3GFsu11bo7XwK5Gcrlisr-U4w17BttJkEE6Q62nWzg2os/pub?gid=231724444&single=true&output=csv" },
        { cat: "MUZIK", sub: "FERAS", title: "ENSEMBLE KIBOD (SR)", form: "https://forms.gle/TS1dwdp5Sa475c5A6", drive: "https://drive.google.com/drive/folders/1XDGCWWX88INptz7fvfIJT4wnRhfDfj3f", csv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSwqbUzkDlJ5LlkBwg2pAFXB8nn8Jke6jAVCdsh0XAlOPcePq2h-WjIEtXXIdWdmXLSwJAzdycg68f1/pub?gid=637401373&single=true&output=csv" },
        { cat: "MUZIK", sub: "FERAS", title: "KOIR (SM)", form: "https://forms.gle/7HcFJMhjtJU9GJH97", drive: "https://drive.google.com/drive/folders/1nECbGOLljQhGgC3fypu0KQGGS1-kCIBk", csv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRAjTsBwlwOxsqKtv7pM3U8J8EbgWsQn4FDZWPsBn31hpQEkgr2Tlr_HpKJAr2-c9uqzlI8-iZ-I9an/pub?gid=12154908&single=true&output=csv" },
        { cat: "MUZIK", sub: "GENTA", title: "NYANYIAN SOLO (SR)", form: "https://forms.gle/caPZtPMd79VyKs4r9", drive: "https://drive.google.com/drive/folders/1xWMAqYscrdRtJh9bR6qwYKRCbQs4ZBos", csv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSnDWEQ5YYQ6i6NcGZ4UT0qFZp_tnlJTbct1PrY8ZiL0FE4FDj047LqOTwGI1S2JZs_4NIVbFzpg01E/pub?gid=253030693&single=true&output=csv" },
        { cat: "MUZIK", sub: "GENTA", title: "KOIR (SR) - GENTA", form: "https://forms.gle/tbD5KtRQHRfxgYLf6", drive: "https://drive.google.com/drive/folders/1G2DPmiX3X3EaglqOSZNDwBGBvQgxlq8H", csv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRaQnxV25OoIhBHNIE2M5dGIcmXrv44CdFkv2-iQfk6Y4JD_w4BaDOdFzoCVrlbJhLzhzIbPvrj6Br5/pub?gid=2007862906&single=true&output=csv" },
        { cat: "MUZIK", sub: "GENTA", title: "NYANYIAN SOLO (SM)", form: "https://forms.gle/NNzwfebqTb4KbDgt7", drive: "https://drive.google.com/drive/folders/1Vbq5OPY3FOFED7yHBjd4q6JF0_CM3bo4", csv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQx58IPEc-vv0ufBwnMl4IE4w33Yu4PmpMoJOnqMUaohuSIElmIQUfUA58Xas9FyBcyelHpFernoq1R/pub?gid=314140766&single=true&output=csv" },
        { cat: "MUZIK", sub: "GENTA", title: "KOIR (SM) - GENTA", form: "https://forms.gle/NksdkKXuiu8uEhBy7", drive: "https://drive.google.com/drive/folders/1OE6p4r5v9gY_dlKqzTULVhWqPNae9eMU", csv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQEAZa7PCURxgzyIu6mFoMiwwa1u5Fw6T2Yc3DJNh9JcAYuVJz5XzSLJthwYuXsEJ1Q36abbmh-EIbx/pub?gid=428299184&single=true&output=csv" },
        // TARI
        { cat: "TARI", sub: "TA'SEEM", title: "TARIAN RAMPAIAN (SR)", form: "https://forms.gle/wDRYvVMLkYPVcNNY6", drive: "https://drive.google.com/drive/folders/1skj69UFgzVpdXyK--zsMFlGVuHNvVcRg", csv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRpc33eO29gAnBJOvTqYtZhW1gm6S-i_ZqBzjp0BlI5YjVYwKVRINKJxEWRJlxmo8bp1I7SUma6sJLl/pub?gid=1766610679&single=true&output=csv" },
        { cat: "TARI", sub: "TA'SEEM", title: "TARIAN ETNIK SOLO (SR)", form: "https://forms.gle/Lu2UoB3Daqu4Ey1r8", drive: "https://drive.google.com/drive/folders/1aEOu_I6XaIzDKS0DCwrrcC4npSgr52QF", csv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSLg2uRtxafPykBsFBVDhdu_XyyaNM7Kdo9sQNEm8Q0c0V4sX_graaFapN7f47ZmMpYSjOs0Z6fUIqk/pub?gid=887063016&single=true&output=csv" },
        { cat: "TARI", sub: "TA'SEEM", title: "TARI PENCAK (SM)", form: "https://forms.gle/eBGMbb1kKKW1UZan8", drive: "https://drive.google.com/drive/folders/1NT9Jd-H1yGTWnM6t1CqOAqIxyCHPJIVC", csv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTHuyPPCz5-1sAfAgXzBj0UepPoH2f85mbsclMEy21CWxt81YaVLEXbe7o0OeAAj2Jf5a20T-cJoLy3/pub?gid=1325506741&single=true&output=csv" },
        { cat: "TARI", sub: "TA'SEEM", title: "TARIAN RAMPAIAN DUO (SM)", form: "https://forms.gle/VDoSw2AokXxC9amX8", drive: "https://drive.google.com/drive/folders/1MMeTSY5QBfE7nZiFOpfMzmfrBlVbi2cg", csv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTCGkqfK8ng4WVbO0d59q9jrsOFVwV1mj4_xmfmhwEP4IUEFpXyq-K-FEsozBAIOS92bNm9vUfOYrfe/pub?gid=836915996&single=true&output=csv" },
        // TEATER
        { cat: "TEATER", sub: "FLLASH", title: "SAYEMBARA TEATER (SR)", form: "https://forms.gle/fqrmxrJ4sU7VhP2NA", drive: "https://drive.google.com/drive/folders/1tm5s4yeiex3XJtZY3r8eeFf4vd8CLR_n", csv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQuhTAeh-DnF1d4C_FD2qXsCThstByc5BDIiY3Mu_9DaQ4TOyR7ZI820j_hYC2biZ75guEpBPlbi9QB/pub?gid=403963652&single=true&output=csv" },
        { cat: "TEATER", sub: "FLLASH", title: "FILEM PENDEK (SR)", form: "https://forms.gle/Ydb8DfzDafyLjhQZ7", drive: "https://drive.google.com/drive/folders/1uEF3tr8N8j09Su7lS2vvJdd4-hliHKeZ", csv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQCaPEcywaG0hmSlbxNlDR7wYCMmDDz38EkcY_z8FVCm7hrOkxl1UIBpOpC72yehRmO-7h6CbjN9i7h/pub?gid=515405520&single=true&output=csv" },
        { cat: "TEATER", sub: "FLLASH", title: "MONOLOG (SR)", form: "https://forms.gle/vWBuL9vV4gZ9uR1A8", drive: "https://drive.google.com/drive/folders/1DpHpzQv0TviwYxtQyN5ka0bDOtJ-7v58", csv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRrWjg5JKEG3u7wuGlurzplsO4cUyKSSnd1r-vBbTNIVpjw4h8GTm3fe3V5ft_XxDubJX3xBlxULzpP/pub?gid=533035291&single=true&output=csv" },
        { cat: "TEATER", sub: "FLLASH", title: "SAYEMBARA TEATER (SM)", form: "https://forms.gle/nkGxFEbKSHeubqUP8", drive: "https://drive.google.com/drive/folders/1IIohADnx86I3_h8gU9kfFqV28p7cr6_S", csv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRwu4OATLjdedRtOHcr7SWW9x6iXDWUlnNxGzf99mdWFhjEbQ4zUkm3olKgxz6q3HpWTtW7ToqW6ePq/pub?gid=2131384172&single=true&output=csv" },
        { cat: "TEATER", sub: "FLLASH", title: "FILEM PENDEK (SM)", form: "https://forms.gle/2LuKJnfVW7T19Y6N6", drive: "https://drive.google.com/drive/folders/1TiHfmYhu8ssjrxbqWfVEwAFoTIwvS4eq", csv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ0K7LWQs8NUvtYWiiaGDDGlezchrLD1hrRrdDyYQ7EJ_xwbh0_CWtOmr89POiCcOUyIodB4mnLGtl9/pub?gid=209262848&single=true&output=csv" },
        { cat: "TEATER", sub: "FLLASH", title: "MONOLOG (SM)", form: "https://forms.gle/HSSXEbysHY1AbHTt9", drive: "https://drive.google.com/drive/folders/1sHZD_sDpmhhy8z9LZ5vNVOQpSkJ3ymNF", csv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ26wvUkYm-XH_q4vNlpSu14-z_5ZsAhRCJak_Qm86z0IODZ2rvOJAo6rl5JAkPabjHkHIMBALXxUl3/pub?gid=1395475141&single=true&output=csv" },
        // SENI VISUAL
        { cat: "SENI VISUAL", sub: "ASEV", title: "SENI CETAKAN (SR)", form: "https://forms.gle/1tBGjxzqsPxSQaZV9", drive: "https://drive.google.com/drive/folders/10EbAVrX7EXF29Gbb62hstkLDDBQGIwSf", csv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ1pzcqC945Gk88ZfoO2GYDTy5Dxog8LYJEO_pwR22TwXuV6SPg0T1NZ9rXhvkx2W8yB-LjiEpXdTOE/pub?gid=1553102662&single=true&output=csv" },
        { cat: "SENI VISUAL", sub: "ASEV", title: "BUSANA (SM)", form: "https://forms.gle/1UtwNE8Cz3aUMS5DA", drive: "https://drive.google.com/drive/folders/1MB7iG9cZ02sfaZAoD9EuVtX8GcUwPk3l", csv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRuHv2axq369VII3Ac-KluGMNpMbn6OjvITnEbRhW2_K58hIZ4WgD0tqKrtdITCv-o987xoeK3hptLO/pub?gid=1117005446&single=true&output=csv" },
        { cat: "SENI VISUAL", sub: "ASEV", title: "IFAC JAPAN (MENENGAH)", form: "https://forms.gle/KTKNghm9C68txT548", drive: "https://drive.google.com/drive/folders/1C_zQ7C6wA25foKXsVzm7NBw_hHZMg0-f", csv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRI4EW00Y7EWoT7kL2tOmohMG-1UbRapHvMJUOaPFsUetifwSbvq4Myt6bRR15FdZYsaA0fJrwLApNH/pub?gid=474159054&single=true&output=csv" },
        { cat: "SENI VISUAL", sub: "NESTLE", title: "KRAF KOLAJ (SR)", form: "#", drive: "#", csv: "" },
        { cat: "SENI VISUAL", sub: "NESTLE", title: "ARCA (SM)", form: "#", drive: "#", csv: "" }
    ];

    // --- SYSTEM INIT ---
    function initSystem() {
        const params = new URLSearchParams(window.location.search);
        const page = params.get('page');
        if(page && DATABASE[page]) bukaPage(parseInt(page));
        else renderDashboardLayout("SEMUA");
        
        document.getElementById('total_events').innerText = DATABASE.length;
    }

    // --- DASHBOARD RENDERING LOGIC ---
    function renderDashboardLayout(activeCat) {
        const tabContainer = document.getElementById('public_tabs');
        const grid = document.getElementById('grid_container');
        const categories = ["SEMUA", "MUZIK", "TARI", "TEATER", "SENI VISUAL"];
        
        tabContainer.innerHTML = "";
        categories.forEach(cat => {
            let btn = document.createElement('div');
            btn.className = `filter-chip ${cat === activeCat ? 'active' : ''}`;
            btn.innerText = cat;
            btn.onclick = () => renderDashboardLayout(cat);
            tabContainer.appendChild(btn);
        });

        grid.innerHTML = "";
        let data = activeCat === "SEMUA" ? DATABASE : DATABASE.filter(i => i.cat === activeCat);
        
        data.forEach((item) => {
            let idx = DATABASE.indexOf(item);
            let card = document.createElement('div');
            card.className = 'detail-card';
            card.onclick = () => bukaPage(idx);
            let countId = `mini_${idx}`;
            
            card.innerHTML = `
                <div class="card-header">
                    <div class="card-badge">${item.sub}</div>
                    <div style="font-size:10px; color:#9ca3af; font-weight:600;">STATUS: DIBUKA</div>
                </div>
                <div class="card-title">${item.title}</div>
                <div style="margin-top:15px;">
                    <div class="progress-row">
                        <div class="p-label">
                            <span>Jumlah Peserta</span>
                            <span id="${countId}">0</span>
                        </div>
                        <div class="p-track"><div class="p-fill" style="width:100%"></div></div>
                    </div>
                </div>
            `;
            grid.appendChild(card);
            fetchCount(item.csv, countId);
        });
    }

    // --- NAVIGATION ---
    function bukaPage(idx) {
        document.getElementById('view_dashboard').classList.add('hidden');
        document.getElementById('view_page').classList.remove('hidden');
        const d = DATABASE[idx];
        document.getElementById('page_title').innerText = d.title;
        document.getElementById('link_form').href = d.form;
        document.getElementById('link_drive').href = d.drive;
        fetchCount(d.csv, 'page_stat');
        currentIndex = idx;
        history.pushState(null, null, `?page=${idx}`);
    }

    function bukaHome() {
        document.getElementById('view_dashboard').classList.remove('hidden');
        document.getElementById('view_page').classList.add('hidden');
        document.getElementById('view_admin').classList.add('hidden');
        history.pushState(null, null, window.location.pathname);
    }

    function bukaAdmin() {
        document.getElementById('view_dashboard').classList.add('hidden');
        document.getElementById('view_page').classList.add('hidden');
        document.getElementById('view_admin').classList.remove('hidden');
    }

    // --- DATA HANDLING ---
    function fetchCount(url, id) {
        if(!url) { document.getElementById(id).innerText="0"; return; }
        fetch(url).then(r=>r.text()).then(t=>{
            let c = t.trim().split('\n').length-1; if(c<0)c=0;
            document.getElementById(id).innerText = c;
            if(id.startsWith('mini')) calcTotal();
        }).catch(()=>{ document.getElementById(id).innerText="0"; });
    }

    function calcTotal() {
        let t=0; document.querySelectorAll('[id^="mini"]').forEach(e => t+=parseInt(e.innerText)||0);
        document.getElementById('grand_total').innerText = t;
        document.getElementById('total_records_display').innerText = t;
    }

    function parseCSV(text) {
        let result = [];
        let cell = '';
        let inQuote = false;
        for (let i = 0; i < text.length; i++) {
            let char = text[i];
            if (char === '"') { inQuote = !inQuote; }
            else if (char === ',' && !inQuote) { result.push(cell.trim()); cell = ''; }
            else { cell += char; }
        }
        result.push(cell.trim());
        return result.map(v => v.replace(/^"|"$/g, '').trim());
    }

    // --- MODAL & STATS (HORIZONTAL BAR CHART) ---
    let chartInstance;
    let currentIndex = null;
    function bukaModalStatistik() {
        if(currentIndex===null) return;
        const d = DATABASE[currentIndex];
        document.getElementById('public_stats_modal').style.display='flex';
        fetch(d.csv).then(r=>r.text()).then(t=>{
            const rows = t.trim().split('\n');
            const stats = {}; const list = [];
            let iSchool = 2; let iDistrict = 1;

            for(let i=1; i<rows.length; i++) {
                if(!rows[i].trim()) continue;
                let c = parseCSV(rows[i]);
                let da = c[iDistrict]||"Lain"; 
                let sc = c[iSchool]||"-";
                da = da.replace(/"/g, '').trim().toUpperCase();
                sc = sc.replace(/"/g, '').trim().toUpperCase();
                stats[da] = (stats[da]||0)+1;
                list.push({s:sc, d:da});
            }
            
            document.getElementById('public_list_body').innerHTML = list.map((x,i)=>
                `<tr><td>${i+1}</td><td style="white-space:normal;">${x.s}</td><td>${x.d}</td></tr>`
            ).join('');
            
            const ctx = document.getElementById('chart_daerah').getContext('2d');
            if(chartInstance) chartInstance.destroy();
            
            // UPDATED: HORIZONTAL BAR CHART CONFIG
            chartInstance = new Chart(ctx, { 
                type: 'bar', // Use bar chart
                data: {
                    labels: Object.keys(stats), 
                    datasets: [{
                        label: 'Jumlah Penyertaan',
                        data: Object.values(stats), 
                        backgroundColor: 'rgba(15, 118, 110, 0.8)', // Primary color with transparency
                        borderColor: '#0f766e',
                        borderWidth: 1,
                        borderRadius: 6, // Rounded corners for bars
                        barPercentage: 0.7 // Make bars slightly thinner
                    }]
                }, 
                options: { 
                    indexAxis: 'y', // IMPORTANT: This makes it horizontal
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: {
                        legend: { display: false }, // Hide legend for cleaner look
                        datalabels: {
                            anchor: 'end',
                            align: 'end',
                            offset: 5,
                            color: '#333',
                            font: { weight: 'bold', size: 12 },
                            formatter: (value) => value
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: { display: false, drawBorder: false },
                            ticks: { font: { size: 11 } }
                        },
                        y: {
                            grid: { display: false, drawBorder: false },
                            ticks: { font: { weight: '600', size: 12 } }
                        }
                    },
                    layout: { padding: { right: 30 } } // Extra padding for datalabels
                } 
            });
        });
    }

    // --- ADMIN ---
    function loginGoogle() { auth.signInWithPopup(provider).catch(e=>alert(e.message)); }
    function logoutGoogle() { auth.signOut().then(()=>location.reload()); }

    auth.onAuthStateChanged(user => {
        if(user && ALLOWED_ADMINS.includes(user.email)) {
            document.getElementById('admin_login_ui').classList.add('hidden');
            document.getElementById('admin_dashboard_ui').classList.remove('hidden');
            document.getElementById('user_display').innerText = user.email;
            document.getElementById('btn_auth').innerHTML = `üîì ${user.email.split('@')[0]}`;
            document.getElementById('btn_auth').classList.add('logged-in');
            renderAdminTabs("MUZIK");
        }
    });

    function renderAdminTabs(active) {
        const c = document.getElementById('category_tabs'); c.innerHTML="";
        ["MUZIK","TARI","TEATER","SENI VISUAL"].forEach(cat=>{
            let b = document.createElement('div'); 
            b.className=`filter-chip ${cat===active?'active':''}`; 
            b.innerText=cat;
            b.onclick=()=>{ renderAdminTabs(cat); }; c.appendChild(b);
        });
        const sub = document.getElementById('sub_category_area'); sub.innerHTML="";
        document.getElementById('table_area').classList.add('hidden');
        DATABASE.filter(d=>d.cat===active).forEach(item=>{
            let b = document.createElement('div'); b.className='sub-card'; b.innerText=item.title;
            b.onclick=()=>{ 
                document.querySelectorAll('.sub-card').forEach(x=>x.classList.remove('selected'));
                b.classList.add('selected'); loadAdminData(item); 
            };
            sub.appendChild(b);
        });
    }

    let adminData = [];
    function loadAdminData(item) {
        if(!item.csv) { alert("Tiada data."); return; }
        document.getElementById('loading_msg').classList.remove('hidden');
        document.getElementById('table_area').classList.add('hidden');
        fetch(item.csv).then(r=>r.text()).then(t=>{
            const rows = t.trim().split('\n');
            const heads = parseCSV(rows[0]);
            adminData = []; 
            let iSchool = 2; let iDistrict = 1;
            adminData.heads = heads;
            adminData.rows = [];
            for(let i=1; i<rows.length; i++) {
                if(!rows[i].trim()) continue;
                let c = parseCSV(rows[i]);
                adminData.rows.push({ full:c, s:c[iSchool]||'-', d:c[iDistrict]||'-' });
            }
            renderTable(adminData.rows);
            document.getElementById('loading_msg').classList.add('hidden');
            document.getElementById('table_area').classList.remove('hidden');
        });
    }

    function renderTable(data) {
        document.getElementById('data_tbody').innerHTML = data.map((r,i)=>`
            <tr><td>${i+1}</td><td style="font-weight:600;color:var(--primary);">${r.s}</td>
            <td><span style="background:#f1f5f9;padding:2px 6px;border-radius:4px;font-size:11px;">${r.d}</span></td>
            <td><button class="btn-view" onclick='openDetail(${i})'>üëÅÔ∏è LIHAT</button></td></tr>
        `).join('');
    }

    function filterTable() {
        let v = document.getElementById('tableSearch').value.toUpperCase();
        renderTable(adminData.rows.filter(r => r.s.toUpperCase().includes(v) || r.d.toUpperCase().includes(v)));
    }

    function openDetail(i) {
        const d = adminData.rows[i];
        let h = "", ph = "";
        adminData.heads.forEach((head, idx) => {
            if(idx===0) return;
            let val = d.full[idx] || "-";
            val = val.replace(/"/g, ''); 
            if(head.toUpperCase().includes('TELEFON') || head.toUpperCase().includes('HP')) {
                ph = val.replace(/[^0-9]/g,''); if(!ph.startsWith('6')) ph='6'+ph;
            }
            if(val.startsWith('http')) val = `<a href="${val}" target="_blank" style="color:blue;">Buka Pautan</a>`;
            h += `<div class="detail-row"><span class="label">${head}</span><span class="value">${val}</span></div>`;
        });
        if(ph) h += `<div class="action-btns"><a href="https://wa.me/${ph}" target="_blank" class="btn-action btn-wa">üí¨ WHATSAPP</a><a href="tel:${ph}" class="btn-action btn-call">üìû CALL</a></div>`;
        document.getElementById('modal_content').innerHTML = h;
        document.getElementById('detail_modal').style.display = 'flex';
    }

    function printAdminData() {
        if(!adminData.rows || adminData.rows.length === 0) { alert("Tiada data untuk dicetak."); return; }
        const selectedBtn = document.querySelector('.sub-card.selected');
        const title = selectedBtn ? selectedBtn.innerText : "Senarai Peserta";
        let printWindow = window.open('', '', 'height=600,width=800');
        let html = `<html><head><title>Cetak - ${title}</title>`;
        html += `<style>body{font-family:sans-serif;padding:20px;}h2{text-align:center;margin-bottom:20px;text-transform:uppercase;}table{width:100%;border-collapse:collapse;font-size:10px;}th,td{border:1px solid #333;padding:5px;text-align:left;vertical-align:top;}th{background-color:#f2f2f2;}@media print{@page{size:landscape;}}</style></head><body>`;
        html += `<h2>${title}</h2><table><thead><tr><th>#</th>`;
        adminData.heads.forEach((h, i) => { if(i !== 0) html += `<th>${h}</th>`; });
        html += `</tr></thead><tbody>`;
        adminData.rows.forEach((row, index) => {
            html += `<tr><td>${index+1}</td>`;
            row.full.forEach((cell, i) => { if(i !== 0) html += `<td>${cell.replace(/"/g, '')}</td>`; });
            html += `</tr>`;
        });
        html += `</tbody></table></body></html>`;
        printWindow.document.write(html);
        printWindow.document.close();
        printWindow.print();
    }

    initSystem();
</script>
</body>
</html>
